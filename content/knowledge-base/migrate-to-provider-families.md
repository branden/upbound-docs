---
title: Migrate to Provider Families
---

The Upbound official [provider families]({{<ref "upbound-marketplace/providers#provider-families">}}) organize provider resources into common, logical, groupings. 
Provider families replace the original monolithic providers, which combined all provider resources into a single Provider package.

Migrating from a monolithic provider to a family provider allows the family provider to take ownership of existing managed resources. 

{{<hint "important" >}}
Upbound only supports migration from Upbound's official monolithic providers. 

Migration from Crossplane community providers to Upbound provider families isn't supported.
{{< /hint >}}

## Backup existing Crossplane resources

Backup the existing Crossplane resources including managed resources, Compositions and Claims.

In case of problems, Crossplane can restore the resources from the YAML files. 

{{<hint "note" >}}
This may take over 10 minutes depending on the number of managed resources in the cluster. 
{{< /hint >}}

```bash 
kubectl get managed -o yaml > backup-mrs.yaml
kubectl get composite -o yaml > backup-composites.yaml
kubectl get claim --all-namespaces -o yaml > backup-claims.yaml
```

## Update the resource deletion policy

Update the deletion policy on all managed resources to `Orphan` to prevent Crossplane from deleting the resources. 

{{<hint "note" >}}
This may take over 10 minutes depending on the number of managed resources in the cluster. 
{{< /hint >}}

```shell
kubectl patch $(kubectl get managed -o name) -p '{"spec":{"deletionPolicy":"Orphan"}}' --type=merge
```

## Create a list of family provider services

Upbound maintains a migration script that maps all existing managed resources to their family provider packages.
This script generates a list of new family providers to install. 

1. Download the script
```bash
wget https://raw.githubusercontent.com/upbound/upjet/main/docs/sp-migration/generate-manifests.sh
chmod +x generate-manifests.sh
```

2. Run the script to generate a list of provider family services. The script produces two files, `sp-family-manual.yaml` for the new provider families provider 
and `sp-manual.yaml` for individual services. 

{{<hint "note" >}}
The script relies on `kubectl` to connect to your Kubernetes cluster.
{{< /hint >}}

```shell {copy-lines="1"}
./generate-manifests.sh
Generating manifests from current cluster
```

The files set the `revisionActivationPolicy` on each provider to `Manual` to prevent the providers from competing over the resources.

## Install the new family provider

Apply the `sp-family-manual.yaml` generated by the script to your cluster.

```shell
kubectl apply -f sp-family-manual.yaml
```

Verify the `upbound-provider-family-` provider is `INSTALLED: False` and `HEALTHY: True`.

```shell {copy-lines="1"}
kubectl get providers
NAME                          INSTALLED   HEALTHY   PACKAGE                                               AGE
upbound-provider-aws          True        True      xpkg.upbound.io/upbound/provider-aws:v0.27.0          26m
upbound-provider-family-aws   False       True      xpkg.upbound.io/upbound/provider-family-aws:v0.37.0   6m56s
```

{{<hint "note" >}}
Family providers use a single `provider-family-` Provider to manage ProviderConfig objects across all service providers in the same family. 
{{< /hint >}}


## Install the family service providers

Use the `sp-manual.yaml` file to install the providers for each service.

```shell
kubectl apply -f sp-manual.yaml
```

Verify the service providers are `INSTALLED: False` and `HEALTHY: True`.

{{<hint "note" >}}
This example only uses a single service, {{<hover label="s3" line="4">}}s3{{</hover>}}.
{{< /hint >}}

```shell {copy-lines="1",label="s3"}
kubectl get providers
NAME                          INSTALLED   HEALTHY   PACKAGE                                                AGE
upbound-provider-aws          True        True      xpkg.upbound.io/upbound/provider-aws:v0.27.0           30m
upbound-provider-aws-s3       False       True      xpkg.upbound.io/upbound-/provider-aws-s3:v0.37.0       5s
upbound-provider-family-aws   False       True      xpkg.upbound.io/upbound-/provider-family-aws:v0.37.0   10m
```

## Remove original Providers as a Configuration dependency

Check for any installed Configurations.

```shell {copy-lines="1"}
kubectl get configurations.pkg
NAME                       INSTALLED   HEALTHY   PACKAGE                                           AGE
upbound-platform-ref-aws   True        True      xpkg.upbound.io/upbound/platform-ref-aws:v0.5.0   3h14m
```

{{<hint "important" >}}
If you don't have an installed Configuration skip to [delete the monolothic provider](#delete-the-original-monolithic-provider).
{{< /hint >}}

Remove any Configuration dependencies on the original Provider to prevent it from being automatically reinstalled.

{{< editCode >}}
```console
kubectl patch configuration.pkg $@<CONFIGURATION_NAME>$@ -p '{"spec":{"skipDependencyResolution": true}}' --type=merge

```
{{</ editCode >}}

### Remove the Crossplane lock 

Edit the Crossplane Lock object and remove the old Provider.

```shell
kubectl edit lock lock
```

Remove the `packages` array item where `type: Configuration` and `dependencies[0].package` is the monolith provider.

{{<expand "An example Lock before editing" >}}
```yaml
apiVersion: pkg.crossplane.io/v1beta1
kind: Lock
metadata:
  creationTimestamp: "2023-05-16T14:37:01Z"
  finalizers:
    - lock.pkg.crossplane.io
  generation: 99
  name: lock
  resourceVersion: "1969272"
  uid: aa60ed13-ec55-4047-b409-b96beb9fe286
packages:
  - dependencies:
      - constraints: '>=v0.31.0'
        package: xpkg.upbound.io/upbound/provider-gcp
        type: Provider
    name: ezgid-test-smaller-provider-migration-3a0d5472dd78
    source: index.docker.io/ezgid/test-smaller-provider-migration
    type: Configuration
    version: v0.4.0
  - dependencies: []
    name: upbound-provider-gcp-a206c0fc297b
    source: xpkg.upbound.io/upbound/provider-gcp
    type: Provider
    version: v0.32.0
```
{{< /expand >}}

{{<expand "An example Lock after editing" >}}
```yaml
apiVersion: pkg.crossplane.io/v1beta1
kind: Lock
metadata:
  creationTimestamp: "2023-05-16T14:37:01Z"
  finalizers:
    - lock.pkg.crossplane.io
  generation: 99
  name: lock
  resourceVersion: "1969272"
  uid: aa60ed13-ec55-4047-b409-b96beb9fe286
packages:
  - dependencies: []
    name: upbound-provider-gcp-a206c0fc297b
    source: xpkg.upbound.io/upbound/provider-gcp
    type: Provider
    version: v0.32.0
```
{{< /expand >}}

## Delete the original monolithic provider

Now delete the original monolithic Provider.

{{< editCode >}}
```console
kubectl delete provider.pkg $@<PROVIDER_NAME>$@
```
{{< /editCode >}}

## Edit the family provider revision activation policy

Change the family provider's `revisionActivationPolicy` from `Manual` to `Automatic`.

```shell
sed 's/revisionActivationPolicy: Manual/revisionActivationPolicy: Automatic/' sp-family-manual.yaml > sp-family-automatic.yaml
```

Apply the updated family provider manifest.

```shell
kubectl apply -f sp-family-automatic.yaml
```

## Verify the provider and resources

View the status of the updated family providers.
```bash {copy-lines="1"}
kubectl get managed
NAME                                                   READY   SYNCED   EXTERNAL-NAME                 AGE
bucket.s3.aws.upbound.io/crossplane-bucket-7000278b2   True    True     crossplane-bucket-7000278b2   59s
```

```bash {copy-lines="1"}
kubectl get provider.pkg
NAME                          INSTALLED   HEALTHY   PACKAGE                                               AGE
upbound-provider-aws          True        True      xpkg.upbound.io/upbound/provider-aws-s3:v0.37.0       4m59s
upbound-provider-family-aws   True        True      xpkg.upbound.io/upbound/provider-family-aws:v0.37.0   3m44s
```

## Restore the resource deletion policy

Restore the resource deletion policy to `Delete`.

```shell
kubectl patch $(kubectl get managed -o name) -p '{"spec":{"deletionPolicy":"Delete"}}' --type=merge
```

The cluster is now fully migrated to a family provider. 